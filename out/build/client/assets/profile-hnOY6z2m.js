import{w as C,a as c}from"./chunk-OIYGIGL5-BjQr_l_M.js";import{j as e}from"./jsx-runtime-D_zvdyIk.js";import{u as N}from"./useQuery-DJjewD8N.js";import{u as E}from"./QueryClientProvider-ChAT3DNt.js";import{u as P}from"./useMutation-CbNZKspy.js";import{u as q}from"./auth-provider-Diczkjh1.js";import{s as g}from"./supabase-BHBWl_Zr.js";import{B as b}from"./button-Lf--0ePE.js";import{I as z}from"./input-B6_poRDs.js";import{S as Q}from"./separator-Bpo7Y29Y.js";import"./useBaseQuery-CE2J4sU2.js";import"./mutation-BtzxBK-B.js";import"./index-yifceNX_.js";import"./utils-BEHD0UYf.js";import"./index-B2a0W2do.js";import"./index-CpAFY4EY.js";async function _(t){const{data:a,error:r}=await g.from("user_data").select("id,email,nrOrdem").eq("id",t.id).maybeSingle();if(r)throw r;return a?{id:a.id,email:a.email,nrOrdem:a.nrOrdem??null}:null}async function M(t,a){const r={id:t.id,email:t.email,nrOrdem:a&&a.trim().length>0?a.trim():null},{error:d}=await g.from("user_data").upsert(r,{onConflict:"id"});if(d)throw d}async function A(t){const{data:a,error:r}=await g.from("user_military_data").select("nrOrdem, nrCpf, nmGuerra, nmPessoa, sgPosto, sgOrg, dataAtualizacao").eq("nrOrdem",t).order("dataAtualizacao",{ascending:!1,nullsFirst:!1}).limit(1).maybeSingle();if(r)throw r;return a??null}function l({label:t,value:a,mono:r=!1}){return e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:t}),e.jsx("div",{className:["rounded-md border bg-card px-3 py-2 text-sm",r?"font-mono":""].join(" "),children:a&&String(a).trim().length>0?a:"—"})]})}function O({title:t,description:a,children:r}){return e.jsxs("section",{className:"rounded-lg border bg-card text-card-foreground p-4 sm:p-6",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h2",{className:"text-base sm:text-lg font-semibold",children:t}),a?e.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground mt-1",children:a}):null]}),r]})}function S({label:t}){return e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("span",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-b-transparent"}),t?e.jsx("span",{children:t}):null]})}const Z=C(function(){const{user:a}=q(),r=E(),[d,h]=c.useState(""),[p,u]=c.useState(null),o=N({queryKey:["user_data",a?.id],enabled:!!a?.id,queryFn:()=>_(a),staleTime:5*6e4,gcTime:10*6e4});c.useEffect(()=>{if(o.isSuccess){const s=o.data?.nrOrdem??"";h(s)}},[o.isSuccess]);const n=c.useMemo(()=>o.data?.nrOrdem??"",[o.data?.nrOrdem]),j=N({queryKey:["military",n],enabled:!!n&&n.trim().length>0,queryFn:()=>A(n),staleTime:2*6e4,gcTime:10*6e4}),f=P({mutationFn:async s=>{if(!a)throw new Error("Usuário não autenticado");await M(a,s)},onMutate:async s=>{u(null),await r.cancelQueries({queryKey:["user_data",a?.id]});const m=r.getQueryData(["user_data",a?.id]),x={id:a.id,email:a.email??m?.email??"",nrOrdem:s&&s.trim().length>0?s.trim():null};return r.setQueryData(["user_data",a?.id],x),{prev:m}},onError:(s,m,x)=>{console.error("Erro ao salvar nrOrdem:",s),x?.prev&&r.setQueryData(["user_data",a?.id],x.prev),u("Não foi possível salvar. Tente novamente.")},onSuccess:()=>{r.invalidateQueries({queryKey:["military"],exact:!1})},onSettled:()=>{r.invalidateQueries({queryKey:["user_data",a?.id]})}}),v=c.useCallback(()=>{const s=d.replace(/\D/g,"");if(s.length>0&&s.length<7){u("Nr. da Ordem parece curto. Confira e tente novamente.");return}a&&f.mutate(s)},[d,f,a]),w=o.isLoading,y=f.isPending,D=j.isLoading,i=j.data??null;return e.jsxs("div",{className:"mx-auto w-full max-w-5xl p-3 sm:p-6",children:[e.jsxs("div",{className:"mb-4 sm:mb-6",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold tracking-tight",children:"Perfil"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Gerencie seu nrOrdem e visualize seus dados militares vinculados."})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:gap-6 md:grid-cols-2",children:[e.jsx(O,{title:"Seus dados",description:"O e-mail é gerenciado pela autenticação. Você pode informar/atualizar seu nrOrdem.",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(l,{label:"E-mail",value:a?.email??o.data?.email??""}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("label",{htmlFor:"nrOrdem",className:"text-xs text-muted-foreground",children:"Nr. da Ordem"}),e.jsx(z,{id:"nrOrdem",value:d,inputMode:"numeric",pattern:"[0-9]*",placeholder:"Ex.: 1234567",onChange:s=>{const m=s.target.value.replace(/\D/g,"");h(m),p&&u(null)},onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),v())}}),p?e.jsx("p",{className:"text-xs text-destructive",children:p}):e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Usado para vincular seus dados militares automaticamente."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{onClick:v,disabled:y||!a,children:y?e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-b-transparent"}),"Salvando..."]}):"Salvar"}),w?e.jsx(S,{label:"Carregando..."}):null]})]})}),e.jsx(O,{title:"Dados militares",description:n?"Encontrados a partir do seu nrOrdem.":"Informe seu nrOrdem para localizar seus dados militares.",children:e.jsx("div",{className:"space-y-4",children:n?D?e.jsx(S,{label:"Buscando dados militares..."}):i?e.jsxs("div",{className:"space-y-3",children:[e.jsx(l,{label:"Nr. da Ordem",value:i.nrOrdem??n,mono:!0}),e.jsx(l,{label:"CPF",value:i.nrCpf,mono:!0}),e.jsx(l,{label:"Nome de Guerra",value:i.nmGuerra}),e.jsx(l,{label:"Nome",value:i.nmPessoa}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(l,{label:"Posto",value:i.sgPosto}),e.jsx(l,{label:"OM",value:i.sgOrg})]}),e.jsx(l,{label:"Atualizado em",value:i.dataAtualizacao?new Date(i.dataAtualizacao).toLocaleString():"—"}),e.jsx("div",{className:"pt-1",children:e.jsx(b,{variant:"outline",size:"sm",onClick:()=>r.invalidateQueries({queryKey:["military",n]}),children:"Recarregar"})})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"Nenhum registro militar encontrado para o nrOrdem informado."}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"Nenhum nrOrdem informado. Preencha seu nrOrdem e salve para tentar localizar seus dados militares."})})})]}),e.jsx(Q,{className:"my-6"}),e.jsxs("div",{className:"rounded-lg border bg-card p-4 sm:p-6",children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:"Dicas"}),e.jsxs("ul",{className:"text-sm text-muted-foreground list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"O número da Ordem deve conter apenas dígitos."}),e.jsx("li",{children:"Após salvar o nrOrdem, use “Recarregar” para atualizar os dados militares."}),e.jsx("li",{children:"Se seus dados militares não aparecerem, confirme se o nrOrdem está correto."})]})]})]})});export{Z as default};

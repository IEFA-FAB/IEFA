import{w as O,A as P,v as B,q as L,a as r}from"./chunk-OIYGIGL5-BjQr_l_M.js";import{j as e}from"./jsx-runtime-D_zvdyIk.js";import{s as R}from"./supabase-BHBWl_Zr.js";import{t as o}from"./index-BRsIKSDg.js";import{B as g}from"./button-Lf--0ePE.js";import"./index-CpAFY4EY.js";import"./index-yifceNX_.js";import"./utils-BEHD0UYf.js";function V(m=new Date){const s=(n,c=0)=>n*60+c,t=m.getHours()*60+m.getMinutes(),a=(n,c)=>t>=n&&t<c;return a(s(4),s(9))?"cafe":a(s(9),s(15))?"almoco":a(s(15),s(20))?"janta":"ceia"}function W(){return new Date().toISOString().split("T")[0]}function J(m,s,t="/rancho"){const a=`${m}${s||""}`,n=a.startsWith("/")&&!a.startsWith("//")?a:t;return encodeURIComponent(n)}const C=3;function Q(m){const s=m,t=s?.code,a=s?.status,n=String(s?.message||"").toLowerCase();return t==="23505"||t===23505||t==="409"||a===409||n.includes("duplicate key")||n.includes("conflict")}const te=O(function(){const[s]=P(),t=B(),a=L(),n=r.useRef(!1),c=r.useRef(null),_=s.get("unit")??s.get("u"),f=r.useMemo(()=>_??"DIRAD - DIRAD",[_]),v=r.useMemo(()=>W(),[]),j=r.useMemo(()=>V(),[]),[l,H]=r.useState(null),[D,b]=r.useState(!1),[N,h]=r.useState("sim"),[p,k]=r.useState(!1),[M,S]=r.useState(null),[u,q]=r.useState(null);r.useEffect(()=>()=>{c.current&&clearInterval(c.current)},[]);const w=r.useCallback((i=C)=>{n.current||(q(i),c.current=setInterval(()=>{q(x=>{const d=(x??1)-1;return d<=0?(c.current&&clearInterval(c.current),n.current||(n.current=!0,t("/rancho",{replace:!0})),null):d})},1e3))},[t]);r.useEffect(()=>{let i=!1;return(async()=>{const{data:d,error:y}=await R.auth.getUser();if(y||!d?.user){if(!n.current){const E=J(a.pathname,a.search);n.current=!0,t(`/login?redirectTo=${E}`,{replace:!0})}return}const U=d.user.id;if(!f){o.error("QR inválido",{description:"A unidade não foi informada."});return}try{H(U);const{data:E,error:$}=await R.schema("sisub").from("mess_halls").select("id").eq("code",f).maybeSingle();if($){console.error("Erro ao buscar mess_hall_id:",$),b(!1),h("sim"),S(null);return}const I=E?.id??null;if(!I){console.warn(`Código de rancho não encontrado: ${f}`),b(!1),h("sim"),S(null);return}S(I);const{data:A,error:F}=await R.schema("sisub").from("meal_forecasts").select("will_eat").eq("user_id",U).eq("date",v).eq("meal",j).eq("mess_hall_id",I).maybeSingle();if(i)return;if(F){console.error("Erro ao buscar previsão:",F),o.message("Não foi possível carregar a previsão. Seguindo sem ela."),b(!1),h("sim");return}b(A?!!A.will_eat:!1),h("sim")}catch(E){if(i)return;console.error("Erro inesperado ao preparar informações:",E),o.error("Erro",{description:"Falha ao carregar informações."}),b(!1),h("sim"),S(null);return}})(),()=>{i=!0}},[v,j,f,t,a.pathname,a.search]);const T=r.useCallback(async()=>{if(!p){if(!l){o.error("Usuário não carregado.");return}k(!0);try{if(N!=="sim"){o.info("Decisão registrada",{description:"Você optou por não entrar para a refeição."});return}let i=M;if(!i){const{data:d,error:y}=await R.schema("sisub").from("mess_halls").select("id").eq("code",f).maybeSingle();if(y||!d?.id){o.error("Rancho inválido",{description:"Código de rancho não encontrado."});return}i=d.id,S(i)}const{error:x}=await R.schema("sisub").from("meal_presences").insert({user_id:l,date:v,meal:j,mess_hall_id:i});if(!x){o.success("Presença registrada",{description:`Bom apetite! Redirecionando em ${C}s...`}),w(C);return}if(Q(x)){o.info("Já registrado",{description:`Sua presença já está registrada para esta refeição. Redirecionando em ${C}s...`}),w(C);return}console.error("Erro ao registrar presença:",x),o.error("Erro",{description:"Não foi possível registrar sua presença."});return}catch(i){console.error("Falha inesperada no envio:",i),o.error("Erro",{description:"Falha inesperada ao enviar a presença."});return}finally{k(!1)}}},[l,N,v,j,f,p,w,M]),z=r.useCallback(()=>{u===null&&t("/rancho")},[t,u]);return e.jsxs("div",{className:"max-w-md mx-auto p-6 text-center space-y-6",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Check-in de Refeição"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Unidade: ",e.jsx("b",{children:f})," • Data: ",e.jsx("b",{children:v})," • Refeição:"," ",e.jsx("b",{children:j})]}),e.jsxs("div",{className:"rounded-md border p-4 text-left space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Está na previsão?"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{disabled:!0,variant:D?"default":"outline",size:"sm",children:"Sim"}),e.jsx(g,{disabled:!0,variant:D?"outline":"default",size:"sm",children:"Não"})]}),l&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["UUID: ",l]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Vai entrar?"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{variant:N==="sim"?"default":"outline",size:"sm",onClick:()=>h("sim"),disabled:!l||p||u!==null,children:"Sim"}),e.jsx(g,{variant:N==="nao"?"default":"outline",size:"sm",onClick:()=>h("nao"),disabled:!l||p||u!==null,children:"Não"})]})]})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center gap-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(g,{onClick:T,disabled:!l||p||u!==null,children:p?"Enviando...":"Enviar"}),e.jsx(g,{variant:"outline",onClick:z,disabled:p||u!==null,children:"Voltar"})]}),u!==null&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Redirecionando para o rancho em ",u,"s..."]})]})]})});export{te as default};

import{v as G,q as J,a,w as K}from"./chunk-OIYGIGL5-BjQr_l_M.js";import{j as e}from"./jsx-runtime-D_zvdyIk.js";import{u as Q}from"./auth-provider-Diczkjh1.js";import{s as W,g as X}from"./redirect-D7e2wz-9.js";import{A as P,a as A,E as Y,b as Z}from"./eye-DMWkklOV.js";import{B as w}from"./button-Lf--0ePE.js";import{C as R,b as V,c as q,d as z,e as D,a as $}from"./card-CfdgI_6O.js";import{I as F}from"./input-B6_poRDs.js";import{C as ee,L as I}from"./label-DlsFJCEv.js";import{c as se}from"./utils-BEHD0UYf.js";import{C as ae,L as te}from"./loader-circle-BLBYjE2T.js";import{L as U}from"./lock-Cn8RQiRM.js";import"./index-yifceNX_.js";import"./createLucideIcon-CwMMISn7.js";import"./index-B2a0W2do.js";import"./index-CpAFY4EY.js";function re(r){const x=new URLSearchParams((r.hash||"").replace(/^#/,"")),i=new URLSearchParams(r.search||"");return{hashParams:x,queryParams:i}}function oe({supabase:r}){const{isLoading:x}=Q(),i=G(),o=J(),[n,B]=a.useState(""),[d,H]=a.useState(""),[g,T]=a.useState(!1),[l,k]=a.useState(!1),[C,h]=a.useState(""),[f,M]=a.useState(!1),[v,u]=a.useState(!0),[b,p]=a.useState(!1),[j,y]=a.useState(""),{tokenHash:N,isRecoveryLink:L}=a.useMemo(()=>{const{hashParams:s,queryParams:t}=re(o),c=s.get("token_hash")||t.get("token_hash")||s.get("token")||t.get("token")||null,m=(o.hash||"").includes("type=recovery");return{tokenHash:c,isRecoveryLink:m}},[o.hash,o.search]);a.useEffect(()=>{let s=!0;async function t(){u(!0),y("");try{const{data:c,error:m}=await r.auth.getSession();if(m&&console.warn("getSession error:",m.message),c?.session?.user){if(!s)return;p(!0),u(!1);return}if(N){const{data:S,error:E}=await r.auth.verifyOtp({type:"recovery",token_hash:N});if(E)throw new Error(E.message||"Falha ao validar o token de recuperação. Solicite um novo link.");if(S?.session?.user){if(!s)return;p(!0),u(!1);const _=o.pathname;i(_,{replace:!0});return}}if(L){const{data:S}=await r.auth.getSession();if(S?.session?.user){if(!s)return;p(!0),u(!1);return}}if(!s)return;y("Link de recuperação inválido ou expirado. Solicite novamente."),p(!1),u(!1)}catch(c){if(!s)return;y(c?.message||"Não foi possível validar o link de recuperação. Solicite novamente."),p(!1),u(!1)}}return t(),()=>{s=!1}},[N,L,i,o.pathname,r]);const O=async s=>{if(s.preventDefault(),h(""),n.length<6){h("A senha deve ter pelo menos 6 caracteres.");return}if(n!==d){h("As senhas não coincidem.");return}if(!b){h("Sessão de recuperação não encontrada. Reabra o link do e-mail.");return}try{k(!0);const{error:t}=await r.auth.updateUser({password:n});if(t){const m=t.message==="Invalid token: token-type not supported"?"Link inválido ou expirado. Solicite novamente.":t.message;throw new Error(m)}M(!0);const c=W(X(o.search,o.state),"/rancho");setTimeout(()=>i(c,{replace:!0}),1200)}catch(t){h(t?.message||"Falha ao atualizar a senha. Tente novamente.")}finally{k(!1)}};return!x&&!b&&(v||j)||!x&&j?e.jsxs(R,{className:"w-full max-w-md mx-auto",children:[e.jsxs(V,{children:[e.jsx(q,{className:"text-2xl text-center",children:v?"Validando link...":"Link inválido"}),e.jsx(z,{className:"text-center",children:v?"Aguarde enquanto validamos seu link de recuperação.":j||"O link de recuperação é inválido ou expirou."})]}),!v&&e.jsx(D,{className:"flex flex-col space-y-3",children:e.jsx(w,{onClick:()=>i("/login"),className:"w-full",children:"Voltar ao Login"})})]}):e.jsxs(R,{className:"w-full max-w-md mx-auto",children:[e.jsxs(V,{className:"space-y-1",children:[e.jsx(q,{className:"text-2xl text-center",children:"Definir nova senha"}),e.jsx(z,{className:"text-center",children:"Crie sua nova senha para acessar o SISUB"})]}),e.jsxs("form",{onSubmit:O,children:[e.jsxs($,{className:"space-y-4",children:[C&&e.jsxs(P,{variant:"destructive",children:[e.jsx(ee,{className:"h-4 w-4"}),e.jsx(A,{children:C})]}),f&&e.jsxs(P,{className:"border-green-200 bg-green-50",children:[e.jsx(ae,{className:"h-4 w-4 text-green-600"}),e.jsx(A,{className:"text-green-800",children:"Senha atualizada com sucesso! Redirecionando..."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"password",children:"Nova senha"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(F,{id:"password",type:g?"text":"password",placeholder:"••••••••",value:n,onChange:s=>B(s.target.value),className:"pl-10 pr-10",required:!0,minLength:6,disabled:l||f,autoComplete:"new-password"}),e.jsx(w,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>T(!g),disabled:l||f,children:g?e.jsx(Y,{className:"h-4 w-4 text-muted-foreground"}):e.jsx(Z,{className:"h-4 w-4 text-muted-foreground"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Mínimo de 6 caracteres."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"confirm",children:"Confirmar nova senha"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(F,{id:"confirm",type:g?"text":"password",placeholder:"••••••••",value:d,onChange:s=>H(s.target.value),className:se("pl-10 pr-10",{"border-red-500 focus-visible:ring-red-500":d.length>0&&d!==n}),required:!0,minLength:6,disabled:l||f,autoComplete:"new-password"})]})]})]}),e.jsxs(D,{className:"flex flex-col space-y-4",children:[e.jsxs(w,{type:"submit",className:"w-full my-2 py-3 text-lg font-semibold",disabled:l||f||!n||!d||n!==d||n.length<6,children:[l&&e.jsx(te,{className:"mr-2 h-4 w-4 animate-spin"}),l?"Atualizando...":"Atualizar senha"]}),e.jsx(w,{type:"button",variant:"outline",className:"w-full",onClick:()=>i("/login"),disabled:l,children:"Voltar ao Login"})]})]})]})}function Ne({}){return[{title:"Reset sua senha"},{name:"description",content:"Altere sua senha"}]}const Se=K(oe);export{Se as default,Ne as meta};

name: Fly Deploy
on:
  push:
    branches:
      - main

# Opcional: permissões mínimas
permissions:
  contents: read

jobs:
  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: fly-deploy-api-${{ github.ref_name }}
      cancel-in-progress: true
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      API_HEALTH_URL: ${{ secrets.API_HEALTH_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Set Fly app secrets
        run: |
          flyctl --config fly.api.toml secrets set \
            API_PORT=${{ secrets.API_PORT }} \
            API_SUPABASE_ANON_KEY=${{ secrets.API_SUPABASE_ANON_KEY }} \
            API_SUPABASE_URL=${{ secrets.API_SUPABASE_URL }} \
            

      - name: Deploy API (wait for health checks)
        run: flyctl deploy -c fly.api.toml --remote-only

      - name: Smoke test API
        shell: bash
        run: |
          set -Eeuo pipefail
          if [[ -z "${API_HEALTH_URL:-}" ]]; then
            echo "API_HEALTH_URL não definido; pulando smoke test."
            exit 0
          fi
          SAFE_URL="${API_HEALTH_URL//\`/}"
          echo "Esperando API responder em $SAFE_URL ..."
          for i in {1..30}; do
            status="$(curl -fsS -o /dev/null -w "%{http_code}" "$SAFE_URL" || true)"
            if [[ "$status" == "200" ]]; then
              echo "OK! API respondeu 200."
              exit 0
            fi
            echo "Tentativa $i/30 - status: $status - aguardando 10s..."
            sleep 10
          done
          echo "Falha: API não respondeu 200 no tempo esperado."
          exit 1

  deploy-docs:
    name: Deploy Docs
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: fly-deploy-docs-${{ github.ref_name }}
      cancel-in-progress: true
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
    defaults:
      run:
        working-directory: ./apps/docs
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Deploy Docs (wait for health checks)
        # Se o arquivo não for exatamente ./apps/docs/fly.toml, use: flyctl deploy -c fly.docs.toml --remote-only --wait-timeout 180
        run: flyctl deploy --remote-only

  deploy-iefa:
    name: Deploy IEFA
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: fly-deploy-iefa-${{ github.ref_name }}
      cancel-in-progress: true
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      IEFA_HEALTH_URL: ${{ secrets.IEFA_HEALTH_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Set Fly app secrets (IEFA)
        env:
          VITE_IEFA_SUPABASE_URL: ${{ secrets.VITE_IEFA_SUPABASE_URL }}
          VITE_IEFA_SUPABASE_ANON_KEY: ${{ secrets.VITE_IEFA_SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail
          flyctl --config fly.iefa.toml secrets set \
            VITE_IEFA_SUPABASE_URL="$VITE_IEFA_SUPABASE_URL" \
            VITE_IEFA_SUPABASE_ANON_KEY="$VITE_IEFA_SUPABASE_ANON_KEY" \
            

      - name: Deploy IEFA (wait for health checks)
        run: |
          flyctl deploy -c fly.iefa.toml --remote-only \
            --build-arg VITE_IEFA_SUPABASE_URL=${{ secrets.VITE_IEFA_SUPABASE_URL }} \
            --build-arg VITE_IEFA_SUPABASE_ANON_KEY=${{ secrets.VITE_IEFA_SUPABASE_ANON_KEY }} \

      - name: Smoke test IEFA
        shell: bash
        run: |
          set -Eeuo pipefail
          if [[ -z "${IEFA_HEALTH_URL:-}" ]]; then
            echo "IEFA_HEALTH_URL não definido; pulando smoke test."
            exit 0
          fi
          SAFE_URL="${IEFA_HEALTH_URL//\`/}"
          echo "Esperando IEFA responder em $SAFE_URL ..."
          for i in {1..30}; do
            status="$(curl -fsSL --ipv4 --max-redirs 5 --connect-timeout 5 --max-time 10 -o /dev/null -w "%{http_code}" "$SAFE_URL" || true)"
            if [[ "${status:0:1}" == "2" ]]; then
              echo "OK! IEFA respondeu $status."
              exit 0
            fi
            echo "Tentativa $i/30 - status: ${status:-(erro de conexão)} - aguardando 10s..."
            sleep 10
          done
          echo "Falha: IEFA não respondeu 2xx no tempo esperado. Cadeia de redirects:"
          curl -sIL --ipv4 --max-redirs 5 "$SAFE_URL" | awk '/^HTTP\/|^Location:/ {print}'
          exit 1


  deploy-sisub:
      name: Deploy SISUB
      runs-on: ubuntu-latest
      timeout-minutes: 20
      concurrency:
        group: fly-deploy-sisub-${{ github.ref_name }}
        cancel-in-progress: true
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        SISUB_HEALTH_URL: ${{ secrets.SISUB_HEALTH_URL }}
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Setup flyctl
          uses: superfly/flyctl-actions/setup-flyctl@v1

        - name: Set Fly app secrets (SISUB)
          env:
            VITE_SISUB_SUPABASE_URL: ${{ secrets.VITE_SISUB_SUPABASE_URL }}
            VITE_SISUB_SUPABASE_ANON_KEY: ${{ secrets.VITE_SISUB_SUPABASE_ANON_KEY }}
          run: |
            set -euo pipefail
            flyctl --config fly.sisub.toml secrets set \
              VITE_SISUB_SUPABASE_URL="$VITE_SISUB_SUPABASE_URL" \
              VITE_SISUB_SUPABASE_ANON_KEY="$VITE_SISUB_SUPABASE_ANON_KEY"

        - name: Deploy SISUB (wait for health checks)
          run: |
            flyctl deploy -c fly.sisub.toml --remote-only \
              --build-arg VITE_SISUB_SUPABASE_URL="${{ secrets.VITE_SISUB_SUPABASE_URL }}" \
              --build-arg VITE_SISUB_SUPABASE_ANON_KEY='${{ secrets.VITE_SISUB_SUPABASE_ANON_KEY }}'

        - name: Smoke test SISUB
          shell: bash
          run: |
            set -Eeuo pipefail
            if [[ -z "${SISUB_HEALTH_URL:-}" ]]; then
              echo "SISUB_HEALTH_URL não definido; pulando smoke test."
              exit 0
            fi
            SAFE_URL="${SISUB_HEALTH_URL//\`/}"
            echo "Esperando SISUB responder em $SAFE_URL ..."
            for i in {1..30}; do
              status="$(curl -fsSL --ipv4 --max-redirs 5 --connect-timeout 5 --max-time 10 -o /dev/null -w "%{http_code}" "$SAFE_URL" || true)"
              if [[ "${status:0:1}" == "2" ]]; then
                echo "OK! SISUB respondeu $status."
                exit 0
              fi
              echo "Tentativa $i/30 - status: ${status:-(erro de conexão)} - aguardando 10s..."
              sleep 10
            done
            echo "Falha: SISUB não respondeu 2xx no tempo esperado. Cadeia de redirects:"
            curl -sIL --ipv4 --max-redirs 5 "$SAFE_URL" | awk '/^HTTP\/|^Location:/ {print}'
            exit 1